<head>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>


 <style>
  /* Style the mytab */
.mytab {
  overflow: hidden;
  border: 1px solid #ccc;
  background-color: #f1f1f1;
}

/* Style the buttons inside the mytab */
.mytab button {
  background-color: inherit;
  float: left;
  border: none;
  outline: none;
  cursor: pointer;
  padding: 14px 16px;
  transition: 0.3s;
  font-size: 17px;
}

/* Change background color of buttons on hover */
.mytab button:hover {
  background-color: #ddd;
}

/* Create an active/current mytablink class */
.mytab button.active {
  background-color: #ccc;
}

/* Style the mytab content */
.mytabcontent {
  display: none;
  padding: 6px 12px;
  border: 1px solid #ccc;
  border-top: none;
  
}

#scrollable-content {
    padding-left: 20px;
  padding-right: 20px;
  height: 300px;
  overflow: auto;
  background-color: white;
}

#friend-scrollable-content {
  padding-left: 20px;
  padding-right: 20px;
  height: 300px;
  overflow: auto;
  background-color: white;
}
#search-scrollable-content {
  padding-left: 20px;
  padding-right: 20px;
  height: 800px;
  overflow: auto;
  background-color: white;
}

.card {
  position: relative;
  height: 80px;
  margin: 20px 20px;
  transition: 0.4s all;
  border-width:1px;
  border-radius:10px;
  border-color:#f2f2f2;
  background-color: white;
  overflow:hidden;
}

.card:hover{
  background-color: #f2f2f2;
}

  @media only screen and (min-width: 200px) {
    .card {
    width:100%;

      margin-top:5px;
      margin-bottom:5px;
      margin-left:auto;
      margin-right:auto;
    }
  }

  @media only screen and (max-device-width: 800px) and (orientation: portrait) {
    .card {
      margin: 12px 10px;
    }
  }

 .user-search-bar {
   width:98%;
   text-align:center;
   height:40px;
}

/* The Modal (background) */
.modal {
  display: none; /* Hidden by default */
  position: fixed; /* Stay in place */
  z-index: 1; /* Sit on top */
  padding-top: 100px; /* Location of the box */
  left: 0;
  top: 0;
  width: 100%; /* Full width */
  height: 100%; /* Full height */
  overflow: auto; /* Enable scroll if needed */
  background-color: rgb(0,0,0); /* Fallback color */
  background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
}

/* Modal Content */
.modal-content {
  background-color: #fefefe;
  margin: auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
}

/* The Close Button */
.close {
  color: #aaaaaa;
  float: right;
  font-size: 28px;
  font-weight: bold;
}

.close:hover,
.close:focus {
  color: #000;
  text-decoration: none;
  cursor: pointer;
}

/* Search grid */
.profilecards {
  display: flex;
  flex-wrap: wrap;
  list-style: none;
  margin: 0;
  padding: 0;
}

.profilecard:before {
  content:'';
  width:100%;
  height:100%;    
  position:absolute;
  left:0;
  top:0;
  background:linear-gradient(rgba(255,255,255,0) 180px, white);
}

.profilecards_item {
  height:550px;
  display: flex;
  padding: 1rem;
}

@media (min-width: 30rem) {
  .profilecards_item {
    width: 33.333%;
  }
}

@media (min-width: 40rem) {
  .profilecards_item {
    width: 25%;
  }
}

@media (min-width: 56rem) {
  .profilecards_item {
    width: 20%;
  }
}

.profilecard {
  border-radius: 0.25rem;
  box-shadow: 0 20px 40px -14px rgba(0, 0, 0, 0.25);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position:relative;
  width:100%; 
}

.profilecard_btn{
  position:absolute;
  bottom:0;
  background: gray;
  border: 0;
  color: white;
  width: 100%;
  display:block;
}

.profilecard_btn:hover{
   background-color: black;
   color:white;
}
.profilecard_content {
}

.user-name{
  text-align:center;
}

.profilecard_title {
  color: #ffffff;
  font-size: 1.1rem;
  font-weight: 700;
  letter-spacing: 1px;
  text-transform: capitalize;
  margin: 0px;
}

.profilecard_text {
  padding:1rem;
  font-size: 1.6rem;
  line-height: 1.5;
  margin-bottom: 1.25rem;    
  font-weight: 400;
}

.row {
  display: flex;
}

/* Create three equal columns that sits next to each other */
.column {
  display:fluid;
  flex: 10%;
  margin: 10px;
  text-align:center;
}

.avatar-image {
    opacity: 0.5;
     cursor: pointer;
     width:80%;
}

.avatar-image:hover {
    opacity: 1;
}
 </style>
 
 <div id="main-incr-content"></div>

<!-- The Profile Modal -->
<div id="profileModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content" style = " width: 50%;">
 
    <div class="modal-header">
        <div class="container-fluid">
          <!-- Control the column width, and how they should appear on different devices -->
          
            <div><span class="close" id="close1">&times;</span></div>
            <button id="friend-friend-follow" class="follow" style="width:30%; position:relative;">---</button>
          
        </div>     
    </div>
    <div class="modal-body" style="text-align:center;">
      
        <br>
        <img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/19339625881548233621-512.png" id="friend-profile-img" style="width:30%;" />
        <br><br>
        <h2 id="friend-username" style="text-align:center;"></h2>
        <hr>
          <div id="friend-descr"></div>
        <hr>
          <button data-toggle="collapse" data-target="#friend-friends" class="btn btn-primary" style="text-align:center; width:100%; background: #2C2C2C; border-color:#2C2C2C;">Friends List</button>
          <div id="friend-friends" class="collapse" style="text-align:center;">
            <br>
            <div id="friend-scrollable-content">
                <div class="all">
                  <div class="cards" id = "friend-friends-grid">          
                  </div>
                </div>                  
            </div>
          </div> 
    </div>
  </div>
</div>

<!-- Settings Modal -->
<div id="settingsModal" class="modal">

  <!-- Modal content -->
  <div class="modal-content" style = " width: 50%;">
 
    <div class="modal-header">
        <div class="container-fluid">
          <!-- Control the column width, and how they should appear on different devices -->
          
            <div><span class="close" id="close">&times;</span></div>
            <h2>Edit Social Profile</h2>
          
        </div>     
    </div>
    <div class="modal-body">
              <div class="row">
                <div class="column">
                    <label style="text-align:center;">Select Avatar</label><br>
            
                </div>
              </div>
              <div class="row">
                <div class="column">
                  <img id = "avatar-diamond" name="diamond" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/diamond.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-art" name="art" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/art.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-tech" name="tech" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/tech.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-games" name="games" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/games.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
              </div>
              <div class="row">
                <div class="column">
                  <img id = "avatar-music" name="music" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/music.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-science" name="science" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/science.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-money" name="money" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/money.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
                <div class="column">
                   <img id = "avatar-photo" name="photo" class ="avatar-image" src="http://127.0.0.1:8080/media/social_icons/photo.png" alt="Snow" onclick="selectAvatar(this.name)">
                </div>
              </div>

              <div class="row">
                <div class="column">
                    <br> <label for="description-input">Description:</label><br><br>
                      <textarea name="description" style="max-height:120px; height: 40px;width:100%;padding-top:5px; padding-left:5px; resize: none;float:left; overflow:auto;" id="description-input" oninput='this.style.height = "";this.style.height = this.scrollHeight + "px"'></textarea>
                </div>
              </div>
    </div>
    <div class="modal-footer" style="border-top: 0 none; text-align:right;"><button class="submit btn btn-default" type="submit" style="width:25%;margin-top:0px;" onclick="saveProfile()" >Save</button></div>
  </div>
</div>

<script>

function saveProfile(){
 
  fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/edit_social_profile?new_image=" + document.querySelector("#profile-img").name + "&new_description=" + document.querySelector("#description-input").value)
    .then(function (response) {
        return response.json();
    })
    .then(function (myJson) {
        
            document.querySelector("#mydescr").innerHTML = document.querySelector("#description-input").value;
      
    })
    .catch(function (error) {
        console.log("Error: " + error);
    });

      var modal = document.getElementById("settingsModal");
      modal.style.display = "none";
}

function selectAvatar(name){
  avatars = document.querySelectorAll("img[id*='avatar']")
  for(var i = 0; i < avatars.length; i++){
    document.getElementById("avatar-" + avatars[i].name).style = "width:80%;";
  }
  document.getElementById("avatar-" + name).style = "width:100%; opacity:1;";
  document.querySelector("#profile-img").src = "http://127.0.0.1:8080/media/social_icons/" + name + ".png";
  document.querySelector("#profile-img").name = name;
  

}

 function followUser(uname,ids){

      
      if (document.getElementById(ids).innerHTML == "Follow"){
        fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/add_friend/" + uname)
        .then(function (response) {
            return response.text();
        })
        .then(function (answer) {
          if(answer == "OK"){
            //alert("You have added " + uname + " to your friends list");
             document.getElementById(ids).innerHTML = "Following";
              
              document.getElementById("follow-" + uname).innerHTML = "Following";
              document.getElementById("friends-grid").innerHTML = "";
              populateWithUsers(populateFriends,"");
          }
        })
        .catch(function (error) {
            console.log("Error: " + error);
        });
      }else if(document.getElementById(ids).innerHTML == "Following"){
         fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/del_friend/" + uname)
          .then(function (response) {
              return response.text();
          })
          .then(function (answer) {
            if(answer == "OK"){
              //alert("You have deleted " + uname + " from your friends list");
              document.getElementById(ids).innerHTML = "Follow";
              document.getElementById("follow-" + uname).innerHTML = "Follow";

              document.getElementById("friends-grid").innerHTML = "";
              populateWithUsers(populateFriends,"");
            }
          })
          .catch(function (error) {
              console.log("Error: " + error);
          });
      }

 }

function updateUsers() {
  //alert(document.getElementById("user-search-bar").value);
  var x = document.querySelector(".user-search-bar").value;
  loadPopulateSearch("http://127.0.0.1:8080/api/retrieve_users_search?uname_contains=" + x);
}

function populateFriendsOfFriends(item,index,follow_text){
         
                 document.getElementById("friend-friends-grid").innerHTML += '<button class="card shadow-1" style="" onclick="showProfileModal(\'' + item[1].username + '\',\'' + item[0].image + '\',\'' + item[0].description + '\',\'' + follow_text + '\')">'+
                                                                  '<div class="container-fluid" style="width:100%;">'+    
                                                                    '<div class="row">'+
                                                                      '<div class="col-sm-3" ><img src="http://127.0.0.1:8080/media/social_icons/' + item[0].image + '.png" id="profile-img" style="min-width:69px;width:70px;height:69px;" /></div>'+
                                                                      '<div class="col-sm-9 " style="text-align:center;font-size: calc(2rem + 1vw);padding-top:10px; padding-right:30px;">' + item[1].username + '</div>'+
                                                                    '</div>'+
                                                                  '</div>'+       
                                                               '</button>';

              
            }



function populateSearch(item,index,follow_text){
   document.getElementById("search-users-grid").innerHTML += '<li class="profilecards_item">'+
                                                        '<div class="profilecard">'+
                                                          '<div class="profilecard" style=" height:500px; cursor: pointer;" onclick="showProfileModal(\'' + item.user.username + '\',\'' + item.social_profile.image + '\',\'' + item.social_profile.description + '\',\'dynamic_follow\')">'+
                                                              '<div class="profilecard_image"><img src="http://127.0.0.1:8080/media/social_icons/' + item.social_profile.image + '.png"  style="width:100%;"></div>'+
                                                                '<div class="profilecard_content">'+
                                                                    '<h2><div class="user-name">' + item.user.username + '</div></h2>' +  
                                                                  '<p class="profilecard_text">' + item.social_profile.description + '</p>' +
                                                                '</div>'+
                                                          '</div>'+
                                                          '<button class="btn profilecard_btn" onClick="followUser(\'' + item.user.username + '\',\'follow-' +  item.user.username + '\')" id = "follow-' + item.user.username  + '">' + follow_text + '</button>'+
                                                        '</div>'+
                                                      '</li>';
               
            }



function populateFriends(item,index){
                 document.getElementById("friends-grid").innerHTML += '<button class="card shadow-1" style="" onclick="showProfileModal(\'' + item[1].username + '\',\'' + item[0].image + '\',\'' + item[0].description + '\',\'Following\')">'+
                                                                  '<div class="container-fluid" style="width:100%;">'+    
                                                                    '<div class="row">'+
                                                                      '<div class="col-sm-3" ><img src="http://127.0.0.1:8080/media/social_icons/' + item[0].image + '.png" id="profile-img" style="min-width:69px;width:70px;height:69px;" /></div>'+
                                                                      '<div class="col-sm-9 " style="text-align:center;font-size: calc(2rem + 1vw);padding-top:10px; padding-right:30px;">' + item[1].username + '</div>'+
                                                                    '</div>'+
                                                                  '</div>'+       
                                                               '</button>';

              
            }

function populateWithUsers(how, extra_args){
     fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/retrieve_friends" + extra_args)
        .then(function (response) {
            return response.json();
        })
        .then(function (myJson) {
            var friends = myJson.friends;
            friends.forEach(how);          
        })
        .catch(function (error) {
            console.log("Error: " + error);
        });
}




function openTab(evt, tabName) {


  if(tabName == "Profile"){
      document.getElementById("friends-grid").innerHTML = "";
      populateWithUsers(populateFriends,"");
    
  }
  var i, mytabcontent, mytablinks;
  mytabcontent = document.getElementsByClassName("mytabcontent");
  for (i = 0; i < mytabcontent.length; i++) {
    mytabcontent[i].style.display = "none";
  }
  mytablinks = document.getElementsByClassName("mytablinks");
  for (i = 0; i < mytablinks.length; i++) {
    mytablinks[i].className = mytablinks[i].className.replace(" active", "");
  }
  document.getElementById(tabName).style.display = "block";
  evt.currentTarget.className += " active";
}


function loadPopulateSearch(url){
    fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/")
        .then(function (response) {
            return response.json();
        })
        .then(function (myJson1) {
            document.querySelector("#profile-img").src = "http://127.0.0.1:8080/media/social_icons/" + myJson1.social_profile.image + ".png";
            document.querySelector("#profile-img").name = myJson1.social_profile.image;
            document.querySelector("#username").innerHTML = myJson1.user.username ;
            document.querySelector("#mydescr").innerHTML = myJson1.social_profile.description ;
            try{
              document.getElementById("avatar-" + myJson1.social_profile.image).style = "width:100%; opacity:1;";
            }catch(e){
              
            }
             var friends =  myJson1.social_profile.data.friends;
             fetch(url)
              .then(function (response) {
                  return response.json();
              })
              .then(function (myJson) {
                  document.getElementById("search-grid").innerHTML = "";
                  document.getElementById("search-users-grid").innerHTML = "";
                  for(var i = 0; i < myJson.results.length; i++){
                      var follow_text = "";
                      if(friends.includes(myJson.results[i].user.username)){
                        follow_text = "Following";
                      }else{
                        follow_text = "Follow";
                      }
                      if( myJson.results[i].user.username != 'dynamic_user' ){
                           // item = myJson.results[i]
                           //index = i
                           populateSearch(myJson.results[i],i,follow_text);
                      }
                     
                  }
              })
              .catch(function (error) {
                  console.log("Error: " + error);
              });

        })
        .catch(function (error) {
            console.log("Error: " + error);
        });
}

function showSettingsModal() {
   
    document.querySelector("#description-input").value = document.querySelector("#mydescr").innerHTML;
     var modal = document.getElementById("settingsModal");

            // Get the <span> element that closes the modal
    var span = document.getElementById("close");

    // When the user clicks on <span> (x), close the modal
    span.onclick = function() {
      modal.style.display = "none";
    }

    // When the user clicks anywhere outside of the modal, close it
    window.onclick = function(event) {
      if (event.target == modal) {
        modal.style.display = "none";
      }
    }
    modal.style.display = "block";
    

}

  function showProfileModal(uname,image,descr,follow_text){

            var modal = document.getElementById("profileModal");
            // Get the <span> element that closes the modal
            var span = document.getElementById("close1");

             // When the user clicks on <span> (x), close the modal
            span.onclick = function() {
              modal.style.display = "none";
            }

            // When the user clicks anywhere outside of the modal, close it
            window.onclick = function(event) {
              if (event.target == modal) {
                modal.style.display = "none";
              }
            }

            document.getElementById("friend-friends-grid").innerHTML = "";
            document.querySelector("#friend-username").innerHTML = uname;
            document.querySelector("#friend-profile-img").src = "http://127.0.0.1:8080/media/social_icons/" + image + ".png";
            document.querySelector("#friend-descr").innerHTML = descr;
            
            if(follow_text == 'dynamic_follow'){
              follow_text =  document.getElementById("follow-" + uname).innerHTML;
            }
      
            document.querySelector("#friend-friend-follow").innerHTML = follow_text;
            document.querySelector("#friend-friend-follow").onclick = function followEvent(){
                                                                          followUser(uname,'friend-friend-follow');
                                                                        }

              fetch("http://127.0.0.1:8080/api/gamers/dynamic_user/retrieve_friends")
                .then(function (response) {
                    return response.json();
                })
                .then(function (myJson1) {
                    var myfriends = myJson1.friends;
                        fetch('http://127.0.0.1:8080/api/gamers/' + uname + '/retrieve_friends')
                        .then(function (response) {
                            return response.json();
                        })
                        .then(function (myJson) {
                                var friend_friends = myJson.friends;  
                                for(var i = 0; i < friend_friends.length; i++){
                                      funame = friend_friends[i][1].username;
                                      var follow_text = "";
                                      for(var j = 0; j < myfriends.length;j++){
                                        
                                          if('dynamic_user' == funame){
                                            follow_text = "---";
                                            break;
                                          }else if(myfriends[j][1].username == funame){
                                            follow_text = "Following";
                                            break;
                                          }else{
                                            follow_text = "Follow";
                                          }
                                      }
                                      populateFriendsOfFriends(friend_friends[i],i,follow_text);
                                }
                                document.getElementById("profileModal").style.display = "block";
                        })
                        .catch(function (error) {
                            console.log("Error: " + error);
                        });          
                })
                .catch(function (error) {
                    console.log("Error: " + error);
                });
    }


document.getElementById("main-incr-content").innerHTML =  '<div style="text-align:center;">'+
                                                              '<h2 id = "header-net"></h2>'+
                                                          '</div>'+
                                                          '<div class="mytab">'+
                                                                '<button class="mytablinks" onclick="openTab(event, \'Profile\')" id="defaultOpen" style="width:50%; max-height:100px; min-width:50px;"><img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/19339625881548233621-512.png" style="width:20%;min-width:20px;min-height:20px;max-width:80px;"/></button>'+
                                                                '<!-- <button class="mytablinks" onclick="openCity(event, \'Paris\')" style="width:33.333%;max-height:100px; min-width:50px;"><img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/16908487151582799501-512.png" style="width:20%;min-width:20px;min-height:20px;"/></button> -->'+
                                                                '<button class="mytablinks" onclick="openTab(event, \'Search\')" style="width:50%;max-height:100px; min-width:50px;"><img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/13416400251535694869-512.png" style="width:20%;min-width:20px;min-height:20px;max-width:80px;"/></button>'+
                                                            '</div>'+
                                                            '<div id="Profile" class="mytabcontent" style="text-align:center;">'+
                                                                '<div style="width:100%; text-align:right;padding-top:20px;padding-right:20px;">'+ 
                                                                  '<a id="link-ep" href="#" onclick="showSettingsModal()" style="width:10%;">'+
                                                                    '<img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/11818001221556279759-512.png" id="profile-edit" style="width:5%;" />'+
                                                                  '</a>'+
                                                                '</div>'+
                                                                '<img src="https://upload-icon.s3.us-east-2.amazonaws.com/uploads/icons/png/19339625881548233621-512.png" name="diamond" id="profile-img" style="width:30%;" />'+
                                                                '<br><br>'+
                                                                '<h2 id="username" style="text-align:center;"></h2>'+
                                                                '<hr>'+
                                                                  '<div id="mydescr"></div>'+
                                                                '<hr>'+
                                                                  '<button data-toggle="collapse" data-target="#friends" class="btn btn-primary" style="text-align:center; width:100%; background: #2C2C2C; border-color:#2C2C2C;">Friends List</button>'+
                                                                  '<div id="friends" class="collapse" style="text-align:center;">'+
                                                                    '<br>'+
                                                                    '<div id="scrollable-content">'+
                                                                        '<div class="all">'+
                                                                          '<div class="cards" id = "friends-grid">'+        
                                                                          '</div>'+
                                                                        '</div>'+              
                                                                    '</div>'+
                                                                  '</div>'+
                                                            '</div>'+
                                                            '<div id="Search" class="mytabcontent">'+
                                                              '<div style= "height:66px; text-align:center;padding-top:10px;">'+
                                                                  '<input type="text" class="user-search-bar" placeholder="Search friends..." name="search2" oninput="updateUsers()" value="">'+
                                                              '</div>'+
                                                              '<main class="grid" id="search-grid">'+
                                                              '</main>'+
                                                              '<div id="search-scrollable-content">'+
                                                                '<ul class="profilecards" id="search-users-grid">'+
                                                                '</ul>'+
                                                              '</div>'+
                                                            '</div>'+
                                                          '</div>';

document.getElementById("defaultOpen").click();
loadPopulateSearch("http://127.0.0.1:8080/api/retrieve_users_search?uname_contains=");
fetch("called_mechanic_url")
    .then(function (response) {
        return response.json();
    })
    .then(function (myJson) {
        document.querySelector("#header-net").innerHTML = (myJson.title);
      
    })
    .catch(function (error) {
        console.log("Error: " + error);
    });

</script>